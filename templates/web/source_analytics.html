<!DOCTYPE html>
<html class="nb_fullscreen">
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
      <a href="http://nb.mit.edu/f/{{ source.id }}?p=<%=page_num%>">
        <div id="page-preview-<%= page_num %>">
          <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
        </div>
      </a>
        <span class="page-num page-label"><%= page_num %></span>
        <div class="page-stats">
          <span class="threads color-stat"><span class="val"><%= num_threads %></span> threads</span>
          <br/><span class="annotations color-stat"><span class="val"><%= num_annotations %></span> annotations</span>
          <br/><span class="questions color-stat"><span class="val"><%= num_questions %></span> replies requested</span>
        </div>
        <div class="clearfix"></div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;"></div>
    </script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      var chart_stats = {{ chart_stats|safe }};
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        // var data = google.visualization.arrayToDataTable(chart_stats, true);
        var data = new google.visualization.DataTable();
        data.addColumn('string','Page');
        data.addColumn('number','Threads');
        data.addColumn('number','Annotations');
        data.addColumn('number','Replies requested');
        data.addRows(chart_stats);
        
        var options = {
          title: 'Page Stats',
          hAxis: {title: 'Page'}
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(data, options);

        var xDelta = 0;
        var yDelta = 13;
        var years = ['1', '2', '3', '4', '5'];
        // jQuery('text').each(function(i, el) {
        //   console.log('found text');
        //   if (years.indexOf(el.textContent) != -1) {
        //     var g = el.parentNode;
        //     var x = el.getAttribute('x');
        //     var y = el.getAttribute('y');
        //     var width = el.getAttribute('width') || 50;
        //     var height = el.getAttribute('height') || 15;

        //     // A "ForeignObject" tag is how you can inject HTML into an SVG document.
        //     var fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject")
        //     fo.setAttribute('x', x - xDelta);
        //     fo.setAttribute('y', y - yDelta);
        //     fo.setAttribute('height', height);
        //     fo.setAttribute('width', width);
        //     var body = document.createElementNS("http://www.w3.org/1999/xhtml", "BODY");
        //     var a = document.createElement("A");
        //     a.href = "http://yahoo.com";
        //     a.setAttribute("style", "color:blue;");
        //     a.innerHTML = el.textContent;
        //     body.appendChild(a);
        //     fo.appendChild(body);

        //     // Remove the original SVG text and replace it with the HTML.
        //     g.removeChild(el);
        //     g.appendChild(fo);
        //   }
        // });
        (function($){
          var pgLabelClass = 'page-label';
          var pgPreviewClass = "pg-preview";

          $('text').each(function(i, el) {
            var obj = $(el);
            var n = obj.text();
            if ($.isNumeric(n)) {
              obj.attr('class', pgLabelClass);
            }
          });

          $('.'+pgLabelClass).on({
            mouseenter: function() {
              var num = $(this).text();
              var contents = $('#page-preview-'+num).html();
              $('.'+pgPreviewClass).html(contents);
              $('.'+pgPreviewClass).children().each(function(i, el) {
                var s = 3;  // scale factor
                $(el).height($(el).height()*s);
                $(el).width($(el).width()*s);
                $(el).css("top", $(el).css("top").replace(/[^-\d\.]/g, '')*s);
                $(el).css("left", $(el).css("left").replace(/[^-\d\.]/g, '')*s);
              });
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

          // to avoid flicker when preview overlaps page number 
          $('.'+pgPreviewClass).on({
            mouseenter: function() {
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

        })(jQuery); 
      }

    </script>
    <script type="text/javascript" src="/content/modules/dev/ui.docAnalyticsBackboneViews.js"></script>

    <script>
    //TO DO: move this!!!!!!!!
  /////////////////////////////////////
            // from http://css-tricks.com/snippets/javascript/lighten-darken-color/
      function LightenDarkenColor(col, amt) {
        
          var usePound = false;
        
          if (col[0] == "#") {
              col = col.slice(1);
              usePound = true;
          }
       
          var num = parseInt(col,16);
       
          var r = (num >> 16) + amt;
       
          if (r > 255) r = 255;
          else if  (r < 0) r = 0;
       
          var b = ((num >> 8) & 0x00FF) + amt;
       
          if (b > 255) b = 255;
          else if  (b < 0) b = 0;
       
          var g = (num & 0x0000FF) + amt;
       
          if (g > 255) g = 255;
          else if (g < 0) g = 0;
       
          return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16);
        
      }

      var hexDigits = new Array
              ("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"); 

      //Function to convert hex format to a rgb color
      function rgb2hex(rgb) {
       rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
       return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
      }

      function hex(x) {
        return isNaN(x) ? "00" : hexDigits[(x - x % 16) / 16] + hexDigits[x % 16];
       }

/////////////////////////////////////////////////
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            var doc = new Document();

            var page;

            for (p in pages) {
              page = new Page(pages[p]);  

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://nb.mit.edu";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/288/33/"+{{ source.id }}+"?ckey="+ckey+";page=" + p;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              doc.add(page);
            }

            var documentView = new DocumentView({
              collection: doc,
              el: $("#pages-container")
            });
            documentView.render();

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              var highlightView = new HighlightView({ model: highlight});
            }

            $("#sort-by").on('change', function() {
              var attr = $(this).val();
              doc.sortByField(attr);
            })

            $("#show-filter").on('change', function() {
              var property = $(this).val();
              var num = 0; // TODO: make this flexible (another HTML property?)
              documentView.filterByPropertyAndNum(property, num);
            })

            $(".color-stat").each(function(i, el) {
              var val = $(el).find(".val").text();
              var o = 1.0;
              var c = rgb2hex($(el).css("color"));
              var newC;
              // gradients set by arbitrary intervals // TODO make them different for each metric?
              if (val > 0) {
                $(el).css("opacity", o);
                if (val < 10) {
                  newC = LightenDarkenColor(c, 20);
                } else if (val < 20) {
                  // newC = LightenDarkenColor(c, -20);
                } else if (val < 30) {
                  newC = LightenDarkenColor(c, -20);
                } else {
                  newC = LightenDarkenColor(c, -40);
                }
                console.log(newC);
                $(el).css("color", newC);
              }
            });
        });
      })(jQuery);
    </script>


  </head>
  <body>
    <div class='nb-viewport'><div class='nb-widget-header' style='height:24px;' /></div>
    <div class="main-wrapper">
      <h1>{{ source.title }}</h1>
      
      <div id="chart_div"></div>

      <div class="controls">
        <label>Show: </label>
        <select id="show-filter">
          <option value="all">All pages</option>
          <option value="num-annotations">Pages with annotations</option>
          <option value="num-questions">Pages with replies requested</option>
        </select>
      
        <label>Sort by: </label>
        <select id="sort-by">
          <option value="page_num">Page number</option>
          <option value="num_annotations">Number of annotations</option>
          <option value="num_questions">Number of replies requested</option>
        </select>
      </div>
      <div id="pages-container"></div>
      <div class="clearfix"></div>
    </div>

    <div class="pg-preview"><img class="img-enlarged" /></div>


  </body>
</html>
