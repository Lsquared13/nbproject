<!DOCTYPE html>
<html class="nb_fullscreen">
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <link type="text/css" href="/content/compiled/temp.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
      <div id="page-preview-<%= page_num %>">
        <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
      </div>
      <span class="page-num page-label"><%= page_num %></span>
      <div class="page-stats">
        <span class="num-threads"><%= num_threads %></span> threads
        <br/><span class="num-annotations"><%= num_annotations %></span> annotations
        <br/><span class="num-questions"><%= num_questions %></span> questions
      </div>
      <div class="clearfix"></div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;"></div>
    </script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      var chart_stats = {{ chart_stats|safe }};
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        // var data = google.visualization.arrayToDataTable(chart_stats, true);
        var data = new google.visualization.DataTable();
        data.addColumn('string','Page');
        data.addColumn('number','Threads');
        data.addColumn('number','Annotations');
        data.addColumn('number','Questions');
        data.addRows(chart_stats);
        
        var options = {
          title: 'Page Stats',
          hAxis: {title: 'Page'}
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(data, options);

        var xDelta = 0;
        var yDelta = 13;
        var years = ['1', '2', '3', '4', '5'];
        // jQuery('text').each(function(i, el) {
        //   console.log('found text');
        //   if (years.indexOf(el.textContent) != -1) {
        //     var g = el.parentNode;
        //     var x = el.getAttribute('x');
        //     var y = el.getAttribute('y');
        //     var width = el.getAttribute('width') || 50;
        //     var height = el.getAttribute('height') || 15;

        //     // A "ForeignObject" tag is how you can inject HTML into an SVG document.
        //     var fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject")
        //     fo.setAttribute('x', x - xDelta);
        //     fo.setAttribute('y', y - yDelta);
        //     fo.setAttribute('height', height);
        //     fo.setAttribute('width', width);
        //     var body = document.createElementNS("http://www.w3.org/1999/xhtml", "BODY");
        //     var a = document.createElement("A");
        //     a.href = "http://yahoo.com";
        //     a.setAttribute("style", "color:blue;");
        //     a.innerHTML = el.textContent;
        //     body.appendChild(a);
        //     fo.appendChild(body);

        //     // Remove the original SVG text and replace it with the HTML.
        //     g.removeChild(el);
        //     g.appendChild(fo);
        //   }
        // });
        (function($){
          var pgLabelClass = 'page-label';
          var pgPreviewClass = "pg-preview";

          $('text').each(function(i, el) {
            var obj = $(el);
            var n = obj.text();
            if ($.isNumeric(n)) {
              obj.attr('class', pgLabelClass);
            }
          });

          $('.'+pgLabelClass).on({
            mouseenter: function() {
              var num = $(this).text();
              var contents = $('#page-preview-'+num).html();
              $('.'+pgPreviewClass).html(contents);
              $('.'+pgPreviewClass).children().each(function(i, el) {
                var s = 3;  // scale factor
                $(el).height($(el).height()*s);
                $(el).width($(el).width()*s);
                $(el).css("top", $(el).css("top").replace(/[^-\d\.]/g, '')*s);
                $(el).css("left", $(el).css("left").replace(/[^-\d\.]/g, '')*s);
              });
              $('.'+pgPreviewClass).show();
            },
            mouseleave: function() {
              $('.'+pgPreviewClass).hide();
            }
          });

        })(jQuery); 
      }

    </script>
    <script type="text/javascript" src="/content/modules/dev/ui.docAnalyticsBackboneViews.js"></script>

    <script>
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            var doc = new Document();

            var page;
            for (var i=1; i <= {{ numpages }}; i++) {
              if (i in pages) {
                page = new Page(pages[i]);  
              } else {
                page = new Page({'page_num': i});
              }

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://nb.mit.edu";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/288/33/"+{{ source.id }}+"?ckey="+ckey+";page=" + i;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              doc.add(page);
            };

            var documentView = new DocumentView({
              collection: doc,
              el: $("#pages-container")
            });
            documentView.render();

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              var highlightView = new HighlightView({ model: highlight});
            }

            $("#sort-by").on('change', function() {
              var attr = $(this).val();
              doc.sortByField(attr);
            })

            $("#show-filter").on('change', function() {
              var property = $(this).val();
              var num = 0; // TODO: make this flexible (another HTML property?)
              documentView.filterByPropertyAndNum(property, num);
            })
        });
      })(jQuery);
    </script>


  </head>
  <body>
    <div class='nb-viewport'><div class='nb-widget-header' style='height:24px;' /></div>
    <div class="main-wrapper">
      <h1>{{ source.title }}</h1>
      
      <div id="chart_div"></div>

      <div class="controls">
        <label>Show: </label>
        <select id="show-filter">
          <option value="all">All pages</option>
          <option value="num-annotations">Pages with annotations</option>
          <option value="num-questions">Pages with questions</option>
        </select>
      
        <label>Sort by: </label>
        <select id="sort-by">
          <option value="page_num">Page number</option>
          <option value="num_annotations">Number of annotations</option>
          <option value="num_questions">Number of questions</option>
        </select>
      </div>
      <div id="pages-container"></div>
      <div class="clearfix"></div>
    </div>

    <div class="pg-preview"><img class="img-enlarged" /></div>


  </body>
</html>
